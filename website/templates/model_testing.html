{% extends "base.html" %}

{% block head_title%}Model Testing{% endblock %}

{% block admin_link %}<a href="{{ url_for('home') }}" class="admin-link"> Return to Main Page</a>{% endblock %}

{% block after_header %}
<br>
<a href="{{ url_for('admin.admin_page') }}" class="return-home"> << Back to admin page</a>
<br>
{% endblock %}

{% block content %}
<main>
    <br>

    <form action="{{ url_for('admin.upload_files') }}" class="form-model_testing", 
        method="post" enctype="multipart/form-data" id="upload-form">
        <img src="static/images/placeholder.jpg">

        <label for="upload numerical dataset" class="global-label">Upload new numerical dataset features (in .csv format): </label> <br>
        <label for="instruction">(Instructions)</label> <br> 
        <input type="file" accept=".csv" name="file_num"> <br> <br> <br>

        <label for="upload nlp dataset" class="global-label">Upload new NLP dataset features (in .csv format): </label> <br>
        <label for="instruction">(Instructions)</label> <br> 
        <input type="file" accept=".csv" name="file_nlp"> <br> <br>

        <button class="global-button" type="submit">
            Test Model
        </button> <br>

        <p id="display-waiting" style="font-size: 17px"></p>
    </form>

    <hr>

    <div>
        <h2 style="margin-left: 5px;">Model Results: </h2>

        <p id="before-results" style="font-size: 20px; display: block; margin-left: 5px;">Model result will show here after testing</p>

        <!-- TODO: design something that makes result lookable -->
        <div class="result-container">
            <div class="num-result-container" style="display: none" id="num-result-container">
                <h3>Numerical Model Test Results</h3>
                <p>Short Position</p>
                <ul id="num-short"></ul>
                <p>Hold Position</p>
                <ul id="num-hold"></ul>
                <p>Long Position</p>
                <ul id="num-long"></ul>

                <p id="accuracy-num-result"></p>
            
                <h3>Confusion Matrix for numerical model</h3>
                <div class="grid-container-num" id="confusion-num"></div>
            </div>

            
            <div class="nlp-result-container" style="display: none" id="nlp-result-container">
                <h3>NLP Model Test Results</h3>
                <p>Negative Position</p>
                <ul id="nlp-neg"></ul>
                <p>Neutral Position</p>
                <ul id="nlp-neu"></ul>
                <p>Positive Position</p>
                <ul id="nlp-pos"></ul>

                <p id="accuracy-nlp-result"></p>

                <h3>Confusion Matrix for NLP</h3>
                <div class="grid-container-nlp" id="confusion-nlp"></div>
            </div>
        </div>

        <div id="num-model-test-img-container" style="display: none">
            <hr>
            <h3>Numerical Model Test Graphs</h3>
            <div class="model-test-img-container">
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="prc-curve-num">
                    <p>Precision-Recall Curve</p>
                </div>
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="roc-curve-num">
                    <p>Receiver Operating Characteristic Curve (With Area Under Curve Value)</p>
                </div>
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="learning-curve">
                    <p>Learning Curve</p>
                </div>
            </div>
        </div>

        <div id="nlp-model-test-img-container" style="display: none">
            <hr>
            <h3>NLP Model Test Graphs</h3>
            <div class="model-test-img-container">
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="prc-curve-nlp">
                    <p>Precision Recall Curve</p>
                </div>
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="roc-curve-nlp">
                    <p>Receiver Operating Characteristic Curve (With Area Under Curve Value)</p>
                </div>
                <div class="model-img-text-box">
                    <img src="static/images/placeholder.jpg" id="threshold-tuning-0-1">
                    <p>Scoring at various threshold (Negative / Neutral)</p>
                </div>
            </div>
        </div>
    </div>

    <div class="model-button-position">
        <button class="global-button" 
            onclick="location.href = '{{ url_for('admin.numerical_model') }}'">
            View Numerical Model
        </button>

        <button class="global-button" 
            onclick="location.href = '{{ url_for('admin.nlp_model') }}'">
            View NLP Model
        </button>

        <button class="global-button" 
            onclick="location.href = '{{ url_for('admin.admin_page') }}'">
            Return to Admin Page
        </button>
    </div>
</main>

<script>
    const num_container = document.getElementById("num-result-container");
    const nlp_container = document.getElementById("nlp-result-container");

    const display_waiting = document.getElementById("display-waiting");

    const confusion_num = document.getElementById("confusion-num");
    const confusion_nlp = document.getElementById("confusion-nlp");

    const form = document.getElementById("upload-form");

    const num_short = document.getElementById("num-short");
    const num_hold = document.getElementById("num-hold");
    const num_long = document.getElementById("num-long");

    const nlp_neg = document.getElementById("nlp-neg");
    const nlp_neu = document.getElementById("nlp-neu");
    const nlp_pos = document.getElementById("nlp-pos");

    const accuracy_num_result = document.getElementById("accuracy-num-result");
    const accuracy_nlp_result = document.getElementById("accuracy-nlp-result");

    const num_img_container = document.getElementById("num-model-test-img-container")
    const nlp_img_container = document.getElementById("nlp-model-test-img-container")

    let num_model_tested = false;
    let nlp_model_tested = false;
    let num_dict, nlp_dict, num_conf_matrix, nlp_conf_matrix;

    form.addEventListener("submit", e => {
        e.preventDefault();
        num_container.style.display = "none";
        nlp_container.style.display = "none";
        num_img_container.style.display = "none";
        nlp_img_container.style.display = "none";

        num_short.innerHTML = "";
        num_hold.innerHTML = "";
        num_long.innerHTML = "";

        nlp_neg.innerHTML = "";
        nlp_neu.innerHTML = ""; 
        nlp_pos.innerHTML = "";

        confusion_num.innerHTML = "" ;
        confusion_nlp.innerHTML = "";

        base_text = "(Estimated 45 seconds) Model testing, this will take a while. " +
            "Do not refresh the page. Please wait";

        const formData = new FormData(form);

        let dots = 0;
        const interval = setInterval(() => {
            dots = dots % 7;

            display_waiting.innerHTML = base_text + ".".repeat(dots);
            dots++;
        }, 500);
    
        fetch("/upload_files", {method: "POST", body: formData})
        .then(response => response.json())
        .then(res => {
            clearInterval(interval)
            num_dict = res.num_dict
            nlp_dict = res.nlp_dict
            num_conf_matrix = res.num_conf_matrix
            nlp_conf_matrix = res.nlp_conf_matrix
            num_model_tested = res.num_model_tested
            nlp_model_tested = res.nlp_model_tested
            accuracy_num = res.accuracy_num
            accuracy_nlp = res.accuracy_nlp
            total_time = res.total_time

            if (num_model_tested) { 
                num_container.style.display = "grid";
                num_img_container.style.display = "inline-block";

                accuracy_num_result.innerHTML = "Overall Accuracy: " + accuracy_num.toFixed(2);

                const num_class_name = ["Short", "Hold", "Long"];
                const num_values = Object.values(num_dict);

                for (let i = 0; i < num_class_name.length; i++) {
                    const current_class = num_class_name[i];
                    Object.entries(num_values[i]).forEach(([metric, value]) => {
                        const li = document.createElement("li");
                        li.textContent = metric + ": " + value.toFixed(2);

                        if (current_class == "Short") {
                            num_short.appendChild(li);
                        }
                        else if (current_class == "Hold") {
                            num_hold.appendChild(li);
                        }
                        else {
                            num_long.appendChild(li);
                        }
                    })
                }

                for (let i = 0; i < num_conf_matrix.length; i++) {
                    scoring = num_conf_matrix[i];
                    for (let j = 0; j < scoring.length; j++) {
                        const box = document.createElement("div");
                        box.className = "box";
                        box.textContent = scoring[j];
                        confusion_num.appendChild(box);
                    }
                }

                const prc_curve_num = document.getElementById("prc-curve-num");
                const roc_curve_num = document.getElementById("roc-curve-num");
                const learning_curve = document.getElementById("learning-curve");

                prc_curve_num.src = "/static/images/model_testing_num/prc_curve.jpg";
                roc_curve_num.src = "/static/images/model_testing_num/roc_curve.jpg";
                learning_curve.src = "/static/images/model_testing_num/learning_curve.jpg";
            }

            if (nlp_model_tested) {
                nlp_container.style.display = "grid";
                nlp_img_container.style.display = "inline-block";

                accuracy_nlp_result.innerHTML = "Overall Accuracy: " + accuracy_nlp.toFixed(2);

                const nlp_class_name = ["Negative", "Neutral", "Positive"];
                const nlp_values = Object.values(nlp_dict);

                for (let i = 0; i < nlp_class_name.length; i++) {
                    const current_class = nlp_class_name[i];
                    Object.entries(nlp_values[i]).forEach(([metric, value]) => {
                        const li = document.createElement("li");
                        li.textContent = metric + ": " + value.toFixed(2);

                        if (current_class == "Negative") {
                            nlp_neg.appendChild(li);
                        }
                        else if (current_class == "Neutral") {
                            nlp_neu.appendChild(li);
                        }
                        else {
                            nlp_pos.appendChild(li);
                        }
                    })
                }

                for (let i = 0; i < nlp_conf_matrix.length; i++) {
                    scoring = nlp_conf_matrix[i];
                    for (let j = 0; j < scoring.length; j++) {
                        const box = document.createElement("div");
                        box.className = "box";
                        box.textContent = scoring[j];
                        confusion_nlp.appendChild(box);
                    }
                }

                const prc_curve_nlp = document.getElementById("prc-curve-nlp")
                const roc_curve_nlp = document.getElementById("roc-curve-nlp")
                const threshold_tuning = document.getElementById("threshold-tuning-0-1")

                prc_curve_nlp.src = "/static/images/model_testing_nlp/prc_curve.jpg"
                roc_curve_nlp.src = "/static/images/model_testing_nlp/roc_curve.jpg"
                threshold_tuning.src = "/static/images/model_testing_nlp/threshold_tuning_class0_class1.jpg"
            }

            if (!num_model_tested && !nlp_model_tested) {
                num_container.style.display = "none";
                nlp_container.style.display = "none";

                display_waiting.innerHTML = "Please upload files first before testing...";
            } else {
                document.getElementById("before-results").style.display = "none";
                display_waiting.innerHTML = "Model testing completed (Total time taken: " + total_time.toFixed(2) + " seconds)";
            }
        })
    });
</script>
{% endblock %}

{% block admin_mode %}<p style="color: red;"><b>Currently in Admin Mode</b></p>{% endblock %}